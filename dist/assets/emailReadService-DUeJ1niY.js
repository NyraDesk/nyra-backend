import{A as g,G as u}from"./index-Dh14THqw.js";class f{getAccessToken(){try{const e=localStorage.getItem("nyra_user"),r=e?JSON.parse(e).email:null;if(!r)return null;const o=localStorage.getItem(`nyra_oauth_${r}`);if(o)try{const s=JSON.parse(o);if(new Date(s.expires_at)>new Date)return s.access_token;localStorage.removeItem(`nyra_oauth_${r}`)}catch{localStorage.removeItem(`nyra_oauth_${r}`)}return null}catch(e){return console.error("Error getting access token:",e),null}}async readEmails(e){var r,o;try{const s=this.getAccessToken();if(!s){const a=localStorage.getItem("nyra_user"),c=a?JSON.parse(a).email:null;if(!c)return{success:!1,emails:[],count:0,error:"Utente non autenticato"};const l=`${g}/auth/google/status?user_id=${encodeURIComponent(c)}`,i=await fetch(l,{credentials:"include"});if(!i.ok)return{success:!1,emails:[],count:0,error:"Connessione Google non disponibile"};const n=await i.json();if(!((r=n==null?void 0:n.gmail)!=null&&r.connected)||!((o=n==null?void 0:n.gmail)!=null&&o.access_token))return{success:!1,emails:[],count:0,error:"Token Gmail non disponibili"};const m=new u(n.gmail.access_token);return await this.fetchEmails(m,e)}const t=new u(s);return await this.fetchEmails(t,e)}catch(s){return console.error("Error reading emails:",s),{success:!1,emails:[],count:0,error:s instanceof Error?s.message:"Errore sconosciuto"}}}async fetchEmails(e,r){try{const o=r.count||5,s=Math.min(o,20);let t="";switch(r.type){case"unread":t="is:unread";break;case"today":t="after:"+this.getTodayDate();break;case"week":t="after:"+this.getWeekAgoDate();break;case"search":t=r.query||"";break;default:t=""}r.filter==="received"?(t+=t?" AND ":"",t+="to:me"):r.filter==="sent"&&(t+=t?" AND ":"",t+="from:me");const a=await e.getMessagesWithQuery(s,t);if(!a||a.length===0)return{success:!0,emails:[],count:0};const c=[];for(const l of a.slice(0,s)){const i=await e.getMessage(l.id);c.push(i)}return{success:!0,emails:c,count:c.length}}catch(o){return console.error("Error fetching email details:",o),{success:!1,emails:[],count:0,error:o instanceof Error?o.message:"Errore nel recupero email"}}}getTodayDate(){return new Date().toISOString().split("T")[0]}getWeekAgoDate(){const e=new Date;return e.setDate(e.getDate()-7),e.toISOString().split("T")[0]}}const k=new f;export{f as EmailReadService,k as emailReadService};
